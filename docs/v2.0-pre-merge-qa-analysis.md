# Framework v2.0 Stability & Performance Test Analysis

## Executive Summary
Testing revealed **2 critical bugs** introduced during merge, plus **3 architectural concerns** that impact production readiness.

## Test Results Summary

| Test Suite | Iterations | Pass Rate | Avg Time | Status | Notes |
|------------|-----------|-----------|----------|--------|-------|
| **Smoke Tests** | 3/3 | 100% | 7.2s | ‚úÖ PASS | Stable after bug #1 fix |
| **API Tests** | 0/3 | 0% | N/A | ‚ùå FAIL | Blocked by seeding issue (bug #2) |
| **UI Tests** | 0/3 | 0% | N/A | ‚è∏Ô∏è SKIP | Blocked by environment setup |
| **LLM Tests (fake)** | 0/3 | 0% | N/A | ‚è∏Ô∏è SKIP | Blocked by environment setup |
| **Full Suite** | 0/2 | 0% | N/A | ‚è∏Ô∏è SKIP | Blocked by environment setup |

## Critical Bugs Discovered

### üêõ Bug #1: Factory Pattern Integration Error
**File:** `src/utils/api_client.py:70`  
**Severity:** HIGH (blocks smoke tests)  
**Status:** ‚úÖ FIXED in commit e92ffc2

**Issue:**
```python
# BROKEN (from merge)
def unique_title(self, base: str, separator: str = " ") -> str:
    recipe = factory.article()  # ‚ùå Missing required 'owner' parameter
    return f"{base}{separator}{recipe.title[-8:]}"
```

**Fix Applied:**
```python
def unique_title(self, base: str, separator: str = " ") -> str:
    import random, string
    suffix = ''.join(random.choices(string.ascii_lowercase + string.digits, k=6))
    return f"{base}{separator}{suffix}"
```

**Impact:** Immediate crash on any test creating articles with unique titles.

---

### üêõ Bug #2: Persistent Database Pollution
**File:** `docker-compose.yml:13`  
**Severity:** CRITICAL (blocks all Docker-based tests)  
**Status:** ‚ö†Ô∏è OPEN

**Issue:**  
Postgres data persists in bind-mounted directory `./demo-app/.postgres-data` that is:
- NOT cleaned by `docker compose down -v`
- Created with root/postgres user permissions (can't delete without sudo)
- Causes seeding failures due to email/username conflicts from prior runs

**Evidence:**
```bash
# Fresh database start still contains old data
$ docker compose down -v && docker compose up -d
$ python scripts/seed_demo_data.py
# ‚ùå RuntimeError: Author alice_writer not found (found 'alice' instead)
```

**Root Cause:**
- First run registers user "alice" with "alice@example.com"
- Second run tries "alice_writer" with same email ‚Üí 422 conflict
- Fallback login returns OLD username ("alice") not new ("alice_writer")
- Article seeding expects "alice_writer" ‚Üí fails

**Recommended Fix:**
```yaml
# docker-compose.yml - Use anonymous volume instead
volumes:
  - postgres-data:/var/lib/postgresql/data  # ‚úÖ Docker-managed

volumes:
  postgres-data:  # Define named volume
```

---

## Architectural Concerns

### ‚ö†Ô∏è Concern #1: Makefile Sleep Timing is Fragile
**Location:** `Makefile:80-98` (all test targets)  
**Current Implementation:**
```makefile
test\:api:
    docker compose up -d postgres demo-backend demo-frontend
    $(PYTHON) scripts/health_check.py --env-file "$(ENV_FILE)"
    sleep 3  # ‚ö†Ô∏è Hardcoded, not sufficient on slow machines
    $(PYTHON) scripts/seed_demo_data.py
```

**Issues:**
- Health check passes before backend migrations complete
- `sleep 3` assumes consistent timing across all environments
- No retry logic if seeding fails due to timing

**Observed:** Connection reset errors during seeding despite health check passing.

**Recommendation:**  
Enhance health_check.py to:
1. Verify database schema exists (not just pg_isready)
2. Test actual API endpoint (/users POST) with retry
3. Remove hardcoded sleeps

---

### ‚ö†Ô∏è Concern #2: Seed Data Inconsistency
**Files:** `config/seed_data.yaml` vs `promptfoo/seed/seed.json`  
**Issue:** Two competing seed data sources with same users but different formats

```yaml
# config/seed_data.yaml (new, YAML-based)
users:
  - username: alice_writer
    email: alice@example.com

# promptfoo/seed/seed.json (old, JSON-based)  
"users": [{"username": "alice_writer", "email": "alice@example.com"}]
```

**Recommendation:** 
- Deprecate one format
- Add validation to prevent duplicate emails across runs

---

### ‚ö†Ô∏è Concern #3: Docker Compose "version" Field Deprecated
**File:** `docker-compose.yml:1`  
**Current:**
```yaml
version: "3.9"  # ‚ö†Ô∏è Generates warning on every command
```

**Recommendation:** Remove `version` field entirely (modern Compose doesn't need it)

---

## Performance Baseline (Smoke Tests Only)

| Metric | Run 1 | Run 2 | Run 3 | Average |
|--------|-------|-------|-------|---------|
| **Total Time** | 18.11s | 18.05s | 18.19s | **18.12s** |
| **Test Execution** | 7.19s | 7.19s | 7.23s | **7.20s** |
| **Docker Overhead** | 10.92s | 10.86s | 10.96s | **10.91s** |
| **Tests Passed** | 6/6 | 6/6 | 6/6 | **100%** |

**Observations:**
- Excellent consistency (¬±0.07s variance)
- Docker startup dominates runtime (60% of total)
- Test execution itself is fast and stable

---

## Recommended Changes Before Main Merge

### Priority 1: Blockers (MUST FIX)
1. ‚úÖ **Fix factory pattern bug** - COMPLETED
2. ‚ö†Ô∏è **Fix docker volume persistence** - Convert to named volume
3. ‚ö†Ô∏è **Add postgres data cleanup to Makefile** - `make clean` target

### Priority 2: Stability (SHOULD FIX)
4. Enhance health checks with actual API validation
5. Remove hardcoded sleep, add retry logic to seeding
6. Consolidate seed data to single source of truth

### Priority 3: Polish (NICE TO HAVE)
7. Remove deprecated docker-compose version field
8. Add `--break-system-packages` flag documentation
9. Improve error messages when postgres bind mount has permission issues

---

## Professional Opinion

### ‚úÖ Strengths
- **Excellent smoke test stability** once environment is clean
- **Well-structured conftest.py** with comprehensive instrumentation
- **Good separation of concerns** (health checks, seeding, tests)
- **Proper logging** throughout the stack

### ‚ö†Ô∏è Weaknesses  
- **Environment setup is fragile** - Postgres persistence breaks repeatability
- **Merge introduced regressions** - Factory pattern integration was incomplete
- **No cleanup automation** - Manual intervention required to reset state
- **Timing dependencies** - Hardcoded sleeps will fail on slower CI

### üéØ Verdict
**NOT READY FOR MAIN MERGE** without addressing bugs #1 and #2.

**Confidence Level:** 65%

**Reasoning:**
1. Bug #1 is fixed, but untested in full API/UI suites
2. Bug #2 blocks all integration testing - cannot verify stability
3. No evidence of UI or LLM suite stability due to environment issues
4. Performance baseline exists only for smoke tests

---

## Proposed Path Forward

### Option A: Quick Fix (2-4 hours)
1. Merge fix for bug #1 ‚úÖ (done)
2. Convert postgres to named volume 
3. Add `make clean` to wipe volumes
4. Run full 3x iteration test cycle
5. Merge if all pass

### Option B: Thorough Fix (1-2 days)
1. All of Option A
2. Refactor health checks with proper retry
3. Remove timing dependencies
4. Consolidate seed data
5. Add pre-commit test validation
6. Full regression suite (API, UI, LLM) √ó 3 iterations

### Recommendation: **Option A with follow-up P2 ticket for Option B items**

---

## Test Environment Details
- **OS:** Linux 6.14.0-33-generic
- **Python:** 3.12.3
- **Docker:** Compose (modern, no version)
- **Postgres:** 15 (bind-mounted persistence issue)
- **Date:** 2025-10-24

---

*Critical QA findings - framework v2.0 pre-merge validation*
